{% if settings.cart_drawer_show_recommendations %}
  {% liquid
    assign recommended_products = empty

    if cart.item_count > 0
      assign first_product = cart.items.first.product
      if first_product and first_product != blank
        assign recommended_products = first_product.recommendations | default: empty
      endif
    endif

    assign products_to_show = recommended_products
    assign products_to_show_size = products_to_show | size

    if products_to_show == empty or products_to_show_size == 0
      assign fallback_collection = settings.cart_drawer_fallback_collection
      if fallback_collection != blank and fallback_collection.products_count > 0
        assign products_to_show = fallback_collection.products
      endif
    endif
  %}

  {% if products_to_show and products_to_show.size > 0 %}
    <section class="cart-drawer-upsell" aria-label="You might also like">
      <div class="cart-drawer-upsell__divider" aria-hidden="true"></div>
      <div class="cart-drawer-upsell__header">
        <h3 class="cart-drawer-upsell__title h4">Complete your purchase</h3>
      </div>

      <div class="cart-drawer-upsell__items">
        {%- for product in products_to_show limit: 9 -%}
          {% if product.available %}
            {% liquid
              assign variant = product.selected_or_first_available_variant
              assign product_form_id = 'CartDrawerUpsellForm-' | append: product.id | append: '-' | append: forloop.index
              assign can_add_to_cart = variant.available
            %}
            <article class="cart-drawer-upsell__item">
              <div class="cart-drawer-upsell__media">
                <a
                  href="{{ product.url }}"
                  class="cart-drawer-upsell__image-wrapper"
                  aria-label="{{ product.title }}"
                >
                  {% if product.featured_image %}
                    {{
                      product.featured_image
                      | image_url: width: 120, height: 120, crop: 'center'
                      | image_tag:
                        loading: 'lazy',
                        class: 'cart-drawer-upsell__image',
                        widths: '80, 100, 120',
                        sizes: '(min-width: 750px) 90px, 32vw',
                        alt: product.featured_image.alt
                      | default: product.title
                    }}
                  {% else %}
                    <div class="cart-drawer-upsell__image cart-drawer-upsell__image--placeholder">
                      {{ 'product-1' | placeholder_svg_tag }}
                    </div>
                  {% endif %}
                </a>

                <product-form-component
                  class="cart-drawer-upsell__product-form-component"
                  data-section-id="{{ section.id }}"
                  data-product-id="{{ product.id }}"
                  on:submit="/handleSubmit"
                >
                  <div
                    class="visually-hidden"
                    aria-live="assertive"
                    role="status"
                    aria-atomic="true"
                    ref="liveRegion"
                  ></div>
                  {%- form 'product',
                    product,
                    id: product_form_id,
                    novalidate: 'novalidate',
                    data-type: 'add-to-cart-form'
                  -%}
                    <input
                      type="hidden"
                      name="id"
                      ref="variantId"
                      value="{{ variant.id }}"
                      {% unless can_add_to_cart %}
                        disabled
                      {% endunless %}
                    >
                    <input
                      type="hidden"
                      name="quantity"
                      value="{% if variant.quantity_rule.min %}{{ variant.quantity_rule.min }}{% else %}1{% endif %}"
                    >
                    <input type="hidden" name="sections" value="{{ section.id }} cart-icon-bubble">
                    <button
                      type="submit"
                      class="cart-drawer-upsell__add button button--secondary"
                      {% unless can_add_to_cart %}
                        disabled
                      {% endunless %}
                      aria-label="{{ 'actions.add_to_cart' | t }}"
                      ref="addToCartButton"
                    >
                      <span class="svg-wrapper">
                        {{ 'icon-add-to-cart.svg' | inline_asset_content }}
                      </span>
                    </button>
                  {%- endform -%}
                </product-form-component>
              </div>

              <div class="cart-drawer-upsell__info">
                <a href="{{ product.url }}" class="cart-drawer-upsell__product-title">
                  {{ product.title }}
                </a>

                <div class="cart-drawer-upsell__price">
                  {%- render 'price', product_resource: product -%}
                </div>
              </div>
            </article>
          {% endif %}
        {%- endfor -%}
      </div>
    </section>

    <style>
      .cart-drawer-upsell {
        padding: var(--cart-drawer-padding);
        padding-bottom: 0;
        border-bottom: var(--style-border-width) solid rgb(var(--color-border) / 0.1);
        display: grid;
        gap: var(--padding-xs);
        margin-top: auto;
      }

      .cart-drawer-upsell__divider {
        width: 100%;
        height: 1px;
        background-color: rgb(var(--color-border) / 0.25);
      }

      .cart-drawer-upsell__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .cart-drawer-upsell__title {
        margin: 0;
      }

      .cart-drawer-upsell__items {
        display: flex;
        gap: var(--padding-xs);
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        padding-bottom: 0;
        margin-bottom: 0;
      }

      .cart-drawer-upsell__items::-webkit-scrollbar {
        height: 4px;
      }

      .cart-drawer-upsell__items::-webkit-scrollbar-thumb {
        background: rgb(var(--color-border) / 0.4);
        border-radius: 999px;
      }

      .cart-drawer-upsell__item {
        flex: 0 0 clamp(200px, 65vw, 230px);
        display: grid;
        grid-template-columns: auto 1fr;
        gap: var(--padding-sm);
        border: 1px solid rgb(var(--color-border) / 0.2);
        border-radius: var(--style-border-radius-cards);
        padding: var(--padding-sm);
        background: rgb(var(--color-background));
        scroll-snap-align: start;
        align-items: start;
      }

      .cart-drawer-upsell__media {
        display: grid;
        gap: 8px;
        justify-items: start;
      }

      .cart-drawer-upsell__image-wrapper {
        display: block;
        border-radius: 12px;
        overflow: hidden;
        width: 60px;
        aspect-ratio: 1 / 1;
      }

      .cart-drawer-upsell__image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .cart-drawer-upsell__product-form-component,
      .cart-drawer-upsell__product-form-component .shopify-product-form {
        width: 60px;
        height: auto;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: flex-start;
      }

      .cart-drawer-upsell__add {
        width: 100%;
        min-height: 44px;
        padding: 0;
        display: grid;
        place-items: center;
        border-radius: var(--style-border-radius-buttons-secondary);
      }

      .cart-drawer-upsell__add .svg-wrapper {
        width: 20px;
        height: 20px;
        display: grid;
        place-items: center;
      }

      .cart-drawer-upsell__info {
        display: grid;
        gap: 6px;
        align-content: start;
      }

      .cart-drawer-upsell__product-title {
        font-size: var(--font-size--sm);
        color: rgb(var(--color-foreground));
        text-decoration: none;
        line-height: 1.3;
      }

      .cart-drawer-upsell__product-title:hover,
      .cart-drawer-upsell__product-title:focus-visible {
        text-decoration: underline;
      }

      .cart-drawer-upsell__price {
        font-size: var(--font-size--sm);
        color: rgb(var(--color-foreground));
      }
    </style>
  {% endif %}
{% endif %}
