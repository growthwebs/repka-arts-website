{% liquid
  assign share_url = share_link | default: shop.url | append: product.url
  if share_link
    assign share_url = share_link
  else
    assign share_url = shop.url | append: product.url
  endif

  assign copy_size = share_copy_size | default: 20
  assign fb_size = share_fb_size | default: 20
  assign wa_size = share_wa_size | default: 17
%}

{% style %}
  .share-row-basic {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 16px;
    flex-wrap: wrap;
  }
  .share-row-basic .share-btn-basic {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: #f4f4f5;
    border: 1px solid #e4e4e7;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-family: inherit;
    font-weight: 500;
    color: #18181b;
    transition: background 0.2s;
    line-height: 1;
    text-decoration: none;
  }
  .share-row-basic .share-btn-basic:hover {
    background: #e4e4e7;
    color: #18181b;
  }
  .share-row-basic .share-icon-basic {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 4px;
    color: #52525b;
    transition: color 0.2s, background 0.2s;
    text-decoration: none;
    padding: 0;
    margin: 0;
  }
  .share-row-basic .share-icon-basic:hover {
    background: #f4f4f5;
    color: #18181b;
  }

  /* Granular Icon Sizes */
  .share-row-basic .share-btn-basic svg {
    width: {{ copy_size }}px;
    height: {{ copy_size }}px;
  }
  .share-row-basic .share-icon-basic.facebook svg {
    width: {{ fb_size }}px;
    height: {{ fb_size }}px;
  }
  .share-row-basic .share-icon-basic.whatsapp svg {
    width: {{ wa_size }}px;
    height: {{ wa_size }}px;
  }

  /* Tooltip for copied state */
  .share-row-basic .share-btn-basic[data-copied='true']::after {
    content: 'Copied!';
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: #18181b;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    pointer-events: none;
    white-space: nowrap;
  }
  .share-row-basic .share-btn-basic {
    position: relative;
  }
{% endstyle %}

<div class="share-row-basic" data-product-url="{{ share_url }}">
  <button class="share-btn-basic copy-link-btn" type="button">
    {% render 'icon-share' %}
    <span class="share-label">Share</span>
  </button>
  <a
    class="share-icon-basic facebook"
    href="https://www.facebook.com/sharer/sharer.php?u={{ share_url }}"
    target="_blank"
    rel="noopener noreferrer"
    aria-label="Share on Facebook"
  >
    {% render 'icon-facebook' %}
  </a>
  <a
    class="share-icon-basic whatsapp"
    href="https://api.whatsapp.com/send?text={{ share_title | default: 'Check this out!' }} {{ share_url }}"
    target="_blank"
    rel="noopener noreferrer"
    aria-label="Share on WhatsApp"
  >
    {% render 'icon-whatsapp' %}
  </a>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Scope to this specific share-row to avoid conflicts if multiple on page
      const shareRows = document.querySelectorAll('.share-row-basic');

      shareRows.forEach((shareRow) => {
        const productUrl = shareRow.getAttribute('data-product-url');
        const copyBtn = shareRow.querySelector('.copy-link-btn');

        if (!copyBtn) return;

        // Ensure we don't attach multiple listeners if this script runs multiple times or multiple snippets
        if (copyBtn.dataset.listenerAttached === 'true') return;
        copyBtn.dataset.listenerAttached = 'true';

        const showTooltip = (element) => {
          element.setAttribute('data-copied', 'true');
          setTimeout(() => {
            element.removeAttribute('data-copied');
          }, 2000);
        };

        const fallbackCopyTextToClipboard = (text, triggerElement) => {
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed'; // Avoid scrolling to bottom
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          try {
            document.execCommand('copy');
            showTooltip(triggerElement);
          } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
          }
          document.body.removeChild(textArea);
        };

        const copyToClipboard = (text, triggerElement) => {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard
              .writeText(text)
              .then(() => {
                showTooltip(triggerElement);
              })
              .catch((err) => {
                console.error('Failed to copy:', err);
                fallbackCopyTextToClipboard(text, triggerElement);
              });
          } else {
            fallbackCopyTextToClipboard(text, triggerElement);
          }
        };

        copyBtn.addEventListener('click', async () => {
          if (navigator.share) {
            try {
              await navigator.share({
                title: document.title, // Or pass share_title via data attribute if strictly needed
                text: 'Check this out!',
                url: productUrl,
              });
              console.log('Shared successfully');
            } catch (err) {
              console.error('Error sharing:', err);
              // Fallback to copy if share fails or is cancelled
              copyToClipboard(productUrl, copyBtn);
            }
          } else {
            copyToClipboard(productUrl, copyBtn);
          }
        });
      });
    });
  </script>
</div>
