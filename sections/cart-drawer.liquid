<script src="{{ 'cart-drawer.js' | asset_url }}" type="module" fetchpriority="low"></script>
<script src="{{ 'product-form.js' | asset_url }}" type="module" fetchpriority="low"></script>

<cart-drawer-component
  class="cart-drawer"
  {% if settings.auto_open_cart_drawer %}
    auto-open
  {% endif %}
>
  {% comment %} Trigger button is now external (in header), but we keep the structure for the dialog {% endcomment %}

  <dialog
    ref="dialog"
    class="cart-drawer__dialog dialog-modal dialog-drawer color-{{ settings.drawer_color_scheme }}{% if cart.empty? %} cart-drawer--empty{%endif%}"
    scroll-lock
  >
    <div class="cart-drawer__inner">
      <cart-items-component class="cart-items-component" data-section-id="{{ section.id }}">
        {%- if cart.empty? -%}
          <div class="cart-drawer__header">
            <button
              ref="closeButton"
              on:click="cart-drawer-component/close"
              class="button close-button cart-drawer__close-button button-unstyled"
              aria-label="{{ 'actions.close_dialog' | t }}"
            >
              <span class="svg-wrapper">
                {{- 'icon-close.svg' | inline_asset_content -}}
              </span>
            </button>
          </div>

          <div class="cart-drawer__content motion-reduce" aria-label="{{ 'accessibility.cart' | t }}">
            <span class="cart-drawer__heading h3 cart-drawer__heading--empty">
              {{ 'content.your_cart_is_empty' | t }}
            </span>

            <div class="cart-drawer__items">
              {% render 'cart-products' %}
            </div>
          </div>
        {%- else -%}
          <div class="cart-drawer__header" id="cart-drawer-header">
            <span class="cart-drawer__heading h3">
              {{ 'content.cart_title' | t }}
              {% render 'cart-bubble' %}
            </span>

            <button
              ref="closeButton"
              on:click="cart-drawer-component/close"
              class="button close-button cart-drawer__close-button button-unstyled"
              aria-label="{{ 'actions.close_dialog' | t }}"
            >
              <span class="svg-wrapper">
                {{- 'icon-close.svg' | inline_asset_content -}}
              </span>
            </button>
          </div>

          <div
            class="cart-drawer__content motion-reduce"
            aria-label="{{ 'accessibility.cart' | t }}"
            style="--header-height: 60px;"
          >
            {% render 'cart-drawer-marquee' %}

            <scroll-hint class="cart-drawer__items">
              {% render 'cart-products' %}
            </scroll-hint>

            {% render 'cart-drawer-upsell' %}

            <div class="cart-drawer__summary">
              {% render 'cart-summary' %}
              {% if settings.cart_show_payment_icons %}
                <div class="cart-drawer__blocks">
                  {% content_for 'blocks' %}
                </div>
              {% endif %}
            </div>
          </div>
        {%- endif -%}
      </cart-items-component>
    </div>
  </dialog>
</cart-drawer-component>

{% stylesheet %}
  .cart-items-component {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  /* ... (keeping original styles, or relying on theme.css) ... */
  .cart-drawer__blocks {
    margin-top: {{ section.settings.payment_icons_margin_top }}px;
    width: 100%;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Cart Drawer",
  "settings": [
    {
      "type": "range",
      "id": "payment_icons_margin_top",
      "min": 0,
      "max": 60,
      "step": 2,
      "unit": "px",
      "label": "Payment icons top margin",
      "default": 10
    }
  ],
  "blocks": [
    {
      "type": "group"
    },
    {
      "type": "icon"
    }
  ],
  "presets": [
    {
      "name": "Cart Drawer"
    }
  ]
}
{% endschema %}
