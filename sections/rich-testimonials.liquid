{% comment %}
  Rich Testimonials Section
  Professional multi-column layout with horizontal scroll on mobile, carousel on desktop.
  Inspired by Tropicfeel's clean, dense list style.
{% endcomment %}

{{ 'section-rich-testimonials.css' | asset_url | stylesheet_tag }}
{{ 'component-slideshow.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<div class="rich-testimonials color-{{ section.settings.color_scheme }} section-{{ section.id }}-padding">
  <div class="page-width">
    {%- if section.settings.heading != blank -%}
      <div class="rich-testimonials__header {{ section.settings.heading_alignment }}">
        <h2 class="rich-testimonials__heading {{ section.settings.heading_size }}">
          {{ section.settings.heading }}
        </h2>
      </div>
    {%- endif -%}

    <div class="rich-testimonials__slider-wrapper">
      <slideshow-component class="rich-testimonials__slideshow" ref="slideshow" initial-slide="0">
        <slideshow-container class="rich-testimonials__slideshow-container" ref="slideshowContainer">
          {%- liquid
            assign nav_icon_setting = section.settings.nav_icon | default: 'large_arrows'
            assign icon_shape = section.settings.nav_icon_background | default: 'circle'

            if nav_icon_setting == 'large_arrows'
              assign icon_style = 'arrows_large'
            elsif nav_icon_setting == 'small_arrows'
              assign icon_style = 'arrow'
            elsif nav_icon_setting == 'chevrons'
              assign icon_style = 'chevron'
            else
              assign icon_style = nav_icon_setting
            endif

            assign nav_color = section.settings.nav_color_scheme | default: section.settings.color_scheme | default: 'scheme-1'
          -%}

          {%
            render 'slideshow-arrows',
            icon_style: icon_style,
            icon_shape: icon_shape,
            arrows_position: 'center',
            class: 'color-' | append: nav_color
          %}

          <slideshow-slides
            class="rich-testimonials__grid list-unstyled"
            ref="scroller"
            tabindex="-1"
            style="
              --slide-width-max: calc(100% / {{ section.settings.columns_desktop }});
              --gap: 2rem;
            "
          >
            {%- liquid
              # Safe sorting by 'order' field
              # If sorting fails or empties the array (e.g. mismatched types), fallback to unsorted.
              assign raw_reviews = shop.metaobjects.review.values
              assign sorted_reviews = raw_reviews | sort: 'order'

              if sorted_reviews != blank
                assign metaobject_reviews = sorted_reviews
              else
                assign metaobject_reviews = raw_reviews
              endif
              assign review_limit = section.settings.max_reviews | default: 8
            -%}

            {%- if metaobject_reviews.count > 0 -%}
              {% comment %} Render from Metaobjects {% endcomment %}
              {%- for review in metaobject_reviews limit: review_limit -%}
                {%- liquid
                  # Robust field fallbacks
                  # Rating: try 'rating', 'stars', 'value'
                  assign rating_key = review.rating.value | default: review.stars.value | default: 5

                  # Date: try 'date', 'review_date'
                  assign date_key = review.date.value | default: review.review_date.value

                  # Title: try 'title', 'heading', 'header'
                  assign title_key = review.title.value | default: review.heading.value | default: review.header.value

                  # Text: try 'review' (user suggestion), 'review_text' (standard), 'text', 'body', 'description'
                  assign text_key = review.review.value | default: review.review_text.value | default: review.text.value | default: review.body.value | default: review.description.value

                  # Author: try 'author_name' (standard), 'author', 'name'
                  assign author_key = review.author_name.value | default: review.author.value | default: review.name.value

                  # Verified: try 'verified', 'is_verified'
                  assign verified_key = review.verified.value | default: review.is_verified.value | default: false

                  # Location: try 'location', 'city', 'place'
                  assign location_key = review.location.value | default: review.city.value | default: review.place.value

                  # Source: try 'source', 'platform'
                  assign source_key = review.source.value | default: review.platform.value
                -%}

                <slideshow-slide class="rich-testimonials__item" ref="slides[]" slide-id="{{ review.system.id }}">
                  <div class="testimonial-card mobile-text-{{ section.settings.card_alignment_mobile }} desktop-text-{{ section.settings.card_alignment }}">
                    <div class="testimonial-card__header">
                      <div class="testimonial-card__stars">
                        {%- for i in (1..5) -%}
                          {%- if i <= rating_key -%}
                            <span class="star-icon filled">★</span>
                          {%- else -%}
                            <span class="star-icon empty">☆</span>
                          {%- endif -%}
                        {%- endfor -%}
                      </div>

                      {%- if date_key != blank -%}
                        <span class="testimonial-card__date">{{ date_key }}</span>
                      {%- endif -%}
                    </div>

                    {%- if title_key != blank -%}
                      <h3 class="testimonial-card__title">{{ title_key }}</h3>
                    {%- endif -%}

                    {%- if text_key != blank -%}
                      <div class="testimonial-card__text">
                        {% comment %} Use simple_format to wrap multi-line text in p tags {% endcomment %}
                        {{ text_key | simple_format }}
                      </div>
                    {%- endif -%}

                    <div class="testimonial-card__author">
                      {%- if author_key != blank -%}
                        <p class="author-name">
                          {{ author_key }}
                          {%- if verified_key == true -%}
                            <span class="verified-badge" title="Verified Customer">
                              <svg viewBox="0 0 20 20" class="icon-verified" width="14" height="14">
                                <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm-1.2 14.4L5.2 10.8l1.6-1.6 2 2 5.6-5.6 1.6 1.6-7.2 7.2z" fill="currentColor"/>
                              </svg>
                            </span>
                          {%- endif -%}
                        </p>
                      {%- endif -%}

                      {%- if location_key != blank or source_key != blank -%}
                        <p class="author-details">
                          {%- if location_key != blank -%}
                            {{ location_key }}
                          {%- endif -%}
                          {%- if location_key != blank and source_key != blank -%}
                            <span class="separator">•</span>
                          {%- endif -%}
                          {%- if source_key != blank -%}
                            {{ source_key }}
                          {%- endif -%}
                        </p>
                      {%- endif -%}
                    </div>
                  </div>
                </slideshow-slide>
              {%- endfor -%}

            {%- else -%}
              {% comment %} Render from Schema Blocks (Fallback) {% endcomment %}
              {%- for block in section.blocks -%}
                {%- if block.type == 'review' -%}
                  <slideshow-slide class="rich-testimonials__item" ref="slides[]" slide-id="{{ block.id }}">
                    <div class="testimonial-card mobile-text-{{ section.settings.card_alignment_mobile }} desktop-text-{{ section.settings.card_alignment }}">
                      <div class="testimonial-card__header">
                        <div class="testimonial-card__stars">
                          {%- for i in (1..5) -%}
                            {%- if i <= block.settings.rating -%}
                              <span class="star-icon filled">★</span>
                            {%- else -%}
                              <span class="star-icon empty">☆</span>
                            {%- endif -%}
                          {%- endfor -%}
                        </div>

                        {%- if block.settings.date != blank -%}
                          <span class="testimonial-card__date">{{ block.settings.date }}</span>
                        {%- endif -%}
                      </div>

                      {%- if block.settings.title != blank -%}
                        <h3 class="testimonial-card__title">{{ block.settings.title }}</h3>
                      {%- endif -%}

                      {%- if block.settings.text != blank -%}
                        <div class="testimonial-card__text">
                          {{ block.settings.text }}
                        </div>
                      {%- endif -%}

                      <div class="testimonial-card__author">
                        {%- if block.settings.author_name != blank -%}
                          <p class="author-name">
                            {{ block.settings.author_name }}
                            {%- if block.settings.verified -%}
                              <span class="verified-badge" title="Verified Customer">
                                <svg viewBox="0 0 20 20" class="icon-verified" width="14" height="14">
                                  <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm-1.2 14.4L5.2 10.8l1.6-1.6 2 2 5.6-5.6 1.6 1.6-7.2 7.2z" fill="currentColor"/>
                                </svg>
                              </span>
                            {%- endif -%}
                          </p>
                        {%- endif -%}

                        {%- if block.settings.author_location != blank or block.settings.author_source != blank -%}
                          <p class="author-details">
                            {%- if block.settings.author_location != blank -%}
                              {{ block.settings.author_location }}
                            {%- endif -%}
                            {%- if block.settings.author_location != blank and block.settings.author_source != blank -%}
                              <span class="separator">•</span>
                            {%- endif -%}
                            {%- if block.settings.author_source != blank -%}
                              {{ block.settings.author_source }}
                            {%- endif -%}
                          </p>
                        {%- endif -%}
                      </div>
                    </div>
                  </slideshow-slide>
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          </slideshow-slides>
        </slideshow-container>
      </slideshow-component>
    </div>

    <div class="rich-testimonials__footer">
      <div class="rich-testimonials__buttons">
        {%- if section.settings.button_label_1 != blank -%}
          <a
            {% if section.settings.button_link_1 == blank %}
              role="link" aria-disabled="true"
            {% else %}
              href="{{ section.settings.button_link_1 }}"
            {% endif %}
            class="button{% if section.settings.button_style_1 == 'secondary' %} button-secondary{% else %} button--primary{% endif %}"
          >
            {{ section.settings.button_label_1 | escape }}
          </a>
        {%- endif -%}

        {%- if section.settings.button_label_2 != blank -%}
          <a
            {% if section.settings.button_link_2 == blank %}
              role="link" aria-disabled="true"
            {% else %}
              href="{{ section.settings.button_link_2 }}"
            {% endif %}
            class="button{% if section.settings.button_style_2 == 'secondary' %} button-secondary{% else %} button--primary{% endif %}"
          >
            {{ section.settings.button_label_2 | escape }}
          </a>
        {%- endif -%}
      </div>
    </div>
  </div>
</div>

<style>
  .rich-testimonials__slider-wrapper {
      position: relative;
  }

  /* Fix for ghost arrow: Ensure disabled arrows are fully transparent */
  .rich-testimonials__slideshow .slideshow-control[disabled] {
    opacity: 0;
    pointer-events: none;
  }

  /* Slideshow Component Styles */
  slideshow-component.rich-testimonials__slideshow {
      display: block;
      position: relative;
  }

  slideshow-container.rich-testimonials__slideshow-container {
      display: block;
      position: relative;
  }

  slideshow-slides.rich-testimonials__grid {
      display: flex;
      gap: 1.5rem;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding-bottom: 2rem;

      /* Mobile: Center the slideshow items */
      padding-inline: calc((100vw - 85vw) / 2);
  }

  slideshow-slides.rich-testimonials__grid::-webkit-scrollbar {
    display: none;
  }

  /* Slide Styles */
  slideshow-slide.rich-testimonials__item {
      display: block;
      /* Mobile: Snap to center to fix visual alignment */
      scroll-snap-align: center;
      width: 85vw; /* Mobile */
      flex-shrink: 0;
      box-sizing: border-box;
  }

  @media screen and (min-width: 750px) {
    slideshow-slides.rich-testimonials__grid {
      overflow-x: hidden; /* Hide scrollbar on desktop */
      width: 100%;
      gap: 2rem;
    }

    slideshow-slide.rich-testimonials__item {
      /* Calculate width based on columns */
      width: calc((100% / {{ section.settings.columns_desktop }}) - (2rem * ({{ section.settings.columns_desktop }} - 1) / {{ section.settings.columns_desktop }}));
    }
  }

  /* Card Styles */
  .testimonial-card {
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 2rem;
    background-color: rgba(var(--color-background), 1);
    border: 1px solid rgba(var(--color-foreground), 0.08);
    border-radius: var(--media-radius);
    transition: transform 0.3s ease;
  }

  .testimonial-card:hover {
    border-color: rgba(var(--color-foreground), 0.2);
  }

  .testimonial-card__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .testimonial-card__stars {
    color: #FFD700; /* Gold */
    letter-spacing: 2px;
  }

  .testimonial-card__date {
    font-size: 0.8em;
    opacity: 0.6;
  }

  .testimonial-card__title {
    margin: 0 0 0.5rem;
    font-family: var(--font-heading-family);
    font-size: 1.1em;
    font-weight: 600;
  }

  .testimonial-card__text {
    flex-grow: 1;
    margin: 0 0 1.5rem;
    font-size: 0.95em;
    line-height: 1.6;
    opacity: 0.85;
    font-style: italic;
  }

  .testimonial-card__text p {
    margin: 0;
  }

  .testimonial-card__text p + p {
    margin-top: 0.75rem;
  }

  .testimonial-card__author {
    border-top: 1px solid rgba(var(--color-foreground), 0.08);
    padding-top: 1rem;
  }

  .author-name {
    margin: 0;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .verified-badge {
    color: #2E7D32; /* Green check */
    display: inline-flex;
    align-items: center;
  }

  .author-details {
    margin: 0.25rem 0 0;
    font-size: 0.85em;
    opacity: 0.6;
  }

  .separator {
    margin: 0 0.25rem;
  }

  .rich-testimonials__footer {
    margin-top: 3rem;
    text-align: center;
  }

  .rich-testimonials__buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .rich-testimonials__header {
    margin-bottom: 2rem;
  }

  .rich-testimonials__header.center { text-align: center; }
  .rich-testimonials__header.left { text-align: left; }

  /* Alignment Utility Classes - Responsive */
  /* Mobile (Default) */
  .testimonial-card.mobile-text-center {
    text-align: center;
  }
  .testimonial-card.mobile-text-center .testimonial-card__header {
    justify-content: center;
  }
  .testimonial-card.mobile-text-center .author-name {
    justify-content: center;
  }

  .testimonial-card.mobile-text-left {
    text-align: left;
  }
  .testimonial-card.mobile-text-left .testimonial-card__header {
    justify-content: space-between;
  }
  .testimonial-card.mobile-text-left .author-name {
    justify: flex-start;
  }

  /* Desktop Override */
  @media screen and (min-width: 750px) {
    .testimonial-card.desktop-text-center {
      text-align: center;
    }
    .testimonial-card.desktop-text-center .testimonial-card__header {
      justify-content: center;
    }
    .testimonial-card.desktop-text-center .author-name {
      justify-content: center;
    }

    .testimonial-card.desktop-text-left {
      text-align: left;
    }
    .testimonial-card.desktop-text-left .testimonial-card__header {
      justify-content: space-between;
    }
    .testimonial-card.desktop-text-left .author-name {
      justify-content: flex-start;
    }
  }

  /* Optional: Stack Header items better in center mode if needed, but existing is fine */
</style>

{% schema %}
{
  "name": "Rich Testimonials",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "default": "Loved by collectors worldwide",
      "label": "Heading"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        { "value": "h2", "label": "Small" },
        { "value": "h1", "label": "Medium" },
        { "value": "h0", "label": "Large" }
      ],
      "default": "h1",
      "label": "Heading size"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ],
      "default": "center",
      "label": "Heading alignment"
    },
    {
      "type": "range",
      "id": "max_reviews",
      "min": 3,
      "max": 50,
      "step": 1,
      "default": 8,
      "label": "Limit number of reviews"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 3,
      "label": "Columns on desktop"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "select",
      "id": "card_alignment",
      "label": "Desktop card alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ],
      "default": "left"
    },
    {
      "type": "select",
      "id": "card_alignment_mobile",
      "label": "Mobile card alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ],
      "default": "left"
    },
    {
      "type": "header",
      "content": "Carousel Navigation"
    },
    {
      "type": "select",
      "id": "nav_icon",
      "label": "Icon",
      "options": [
        {
          "value": "large_arrows",
          "label": "Large arrows"
        },
        {
          "value": "small_arrows",
          "label": "Small arrows"
        },
        {
          "value": "chevrons",
          "label": "Chevrons"
        }
      ],
      "default": "large_arrows"
    },
    {
      "type": "select",
      "id": "nav_icon_background",
      "label": "Icon background",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "circle",
          "label": "Circle"
        },
        {
          "value": "square",
          "label": "Square"
        }
      ],
      "default": "circle"
    },
    {
      "type": "color_scheme",
      "id": "nav_color_scheme",
      "label": "Navigation color scheme",
      "default": "scheme-1",
      "info": "Color scheme for the navigation arrows"
    },
    {
      "type": "header",
      "content": "Buttons"
    },
    {
      "type": "text",
      "id": "button_label_1",
      "default": "Leave a review",
      "label": "Button 1 label"
    },
    {
      "type": "url",
      "id": "button_link_1",
      "label": "Button 1 link"
    },
    {
      "type": "select",
      "id": "button_style_1",
      "label": "Button 1 style",
      "options": [
        { "value": "primary", "label": "Primary" },
        { "value": "secondary", "label": "Secondary" }
      ],
      "default": "primary"
    },
    {
      "type": "text",
      "id": "button_label_2",
      "default": "Find your art piece",
      "label": "Button 2 label"
    },
    {
      "type": "url",
      "id": "button_link_2",
      "label": "Button 2 link"
    },
    {
      "type": "select",
      "id": "button_style_2",
      "label": "Button 2 style",
      "options": [
        { "value": "primary", "label": "Primary" },
        { "value": "secondary", "label": "Secondary" }
      ],
      "default": "secondary"
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "review",
      "name": "Review",
      "settings": [
        {
          "type": "range",
          "id": "rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "label": "Star rating",
          "default": 5
        },
        {
          "type": "text",
          "id": "title",
          "label": "Review title",
          "default": "Excellent quality"
        },
        {
          "type": "richtext",
          "id": "text",
          "label": "Review text",
          "default": "<p>Share what your customers are saying about your products or service.</p>"
        },
        {
          "type": "text",
          "id": "author_name",
          "label": "Author name",
          "default": "Author's name"
        },
        {
          "type": "checkbox",
          "id": "verified",
          "default": true,
          "label": "Show verified badge"
        },
        {
          "type": "text",
          "id": "author_location",
          "label": "Location",
          "default": "Los Angeles, CA"
        },
        {
          "type": "text",
          "id": "author_source",
          "label": "Source",
          "default": "via Google"
        },
        {
          "type": "text",
          "id": "date",
          "label": "Review Date (Optional)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Rich Testimonials",
      "blocks": [
        {
          "type": "review"
        },
        {
          "type": "review"
        },
        {
          "type": "review"
        }
      ]
    }
  ]
}
{% endschema %}
